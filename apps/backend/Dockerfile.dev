FROM node:22-alpine

# Set working directory
WORKDIR /app

# Install pnpm globally
RUN corepack enable

# Copy root package files for workspace setup
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy backend package.json
COPY apps/backend/package.json ./apps/backend/

# Install all dependencies from root
RUN pnpm install --frozen-lockfile

# Copy backend source code (excluding node_modules)
COPY apps/backend/src ./apps/backend/src
COPY apps/backend/test ./apps/backend/test
COPY apps/backend/tsconfig*.json ./apps/backend/
COPY apps/backend/nest-cli.json ./apps/backend/
COPY apps/backend/eslint.config.mjs ./apps/backend/

# Switch to backend directory
WORKDIR /app/apps/backend

# Expose port
EXPOSE 3000

# Start in development mode with watch
CMD ["pnpm", "run", "dev"]
